define(["jquery","appsecute-api/lib/event","appsecute-api/lib/logger","appsecute-api/lib/utils","appsecute-api/lib/start","appsecute-api/lib/priority-queue","appsecute-api/lib/http-client","appsecute-api/lib/settings"],function(e,t,n,i,u,r,o,a){var c=!0,s=3,l=500,d=null,p=0,f=new n("Appsecute Api"),h=null,g={},b=new t("Http Request Failed",this),v=new t("Authentication Required",this),y=function(){h=new r(D),u.startDocumentUriSet.subscribe(function(){d=setTimeout(U,l)},this)},T=function(e){g[e.id]=e,o.executeHttpRequest(e,e.timeout||a.httpRequestTimeOut,x,m)},x=function(e,t){p--,g[e.id]&&delete g[e.id],e.isCancelled||(f.info(e.verb+" to '"+e.url+"' succeeded with status code "+t.status_code),i.isFunction(e.success)&&(e.context?e.success.apply(e.context,[e,t]):e.success(e,t)))},m=function(e,t){p--,g[e.id]&&delete g[e.id],e.isCancelled||(f.error(e.verb+" to '"+e.url+"' failed with status code "+t.status_code),e.failureCount++,e.lastFailureTime=new Date,e.failedDueToUnauthorized=401===t.status_code,e.failedDueToUnauthorized?(c=!1,v.trigger(e,t),q(e)):i.isFunction(e.error)&&(e.context?e.error.apply(e.context,[e,t]):e.error(e,t)),e.suppressGlobal===!0||e.failedDueToUnauthorized||b.trigger({request:e,response:t}))},q=function(e){h.add(e),w()},D=function(e,t){return e.priority===t.priority?0:e.priority>t.priority?1:-1},C=function(){var e=!0;return null===h.peek()?e=!1:p>=s&&(e=!1),e},U=function(e){for(var t=[];C();){var n=h.next();n.isCancelled||(!n.failedDueToUnauthorized||n.failedDueToUnauthorized&&c===!0?(T(n),p++):t.push(n))}var i;for(i=0;i<t.length;i++)h.add(t[i]);e!==!0&&(d=setTimeout(U,l))},w=function(){U(!0)},z=function(e){e.isCancelled=!0,e.handle&&e.handle.abort(),f.debug("Cancelled request to "+e.url),i.isFunction(e.cancelled)&&(e.context?e.cancelled.apply(e.context,[e]):e.cancelled(e))},A=function(e,t,n,u){u=u||{};var r={id:i.getGuid(),url:t,verb:e,data:n,priority:u.priority||1,state:u.state,description:u.description,success:u.success,error:u.error,context:u.context,headers:u.headers,suppressGlobal:u.suppressGlobal,timeout:u.timeout,tag:u.tag,failureCount:0,isCancelled:!1,failedDueToUnauthorized:!1};return h.add(r),w(),r.id};return y(),{httpRequestFailed:b,queueSizeChanged:h.queueSizeChanged,authenticationRequired:v,setStartDocumentUri:function(e){u.setStartDocumentUri(e)},setLocalStartDocument:function(e){u.setLocalStartDocument(e)},getQueuedRequests:function(){var e=[],t=0;for(t=0;t<h.count();t++)e.push(h.peekAtIndex(t));return e},cancelById:function(e){if(g[e])z(g[e]);else{var t;for(t=0;t<h.count();t++){var n=h.peekAtIndex(t);if(n.id===e){z(n),h.removeAtIndex(t);break}}}},cancelByTag:function(e){var t;for(t in g)if(g.hasOwnProperty(t)){var n=g[t];n.tag===e&&z(n)}var i,u=!1;for(i=0;i<h.count();i++){var r=h.peekAtIndex(i);if(r.tag===e){z(r),h.removeAtIndex(i),u=!0;break}}u&&this.cancelByTag(e)},retry:function(e){q(e)},restart:function(){c=!0,w()},get:function(e,t){return A("GET",e,null,t)},put:function(e,t,n){return A("PUT",e,t,n)},post:function(e,t,n){return A("POST",e,t,n)},delete_:function(e,t){return A("DELETE",e,null,t)}}});
//# sourceMappingURL=api.js.map